{{- $ns := .Release.Namespace }}
{{- $img := .Values.image }}
{{- $services := int .Values.server.services | default 1}}
{{- $load := .Values.load }}
{{- $linkerd := deepCopy .Values.linkerd | merge $load.linkerd }}
{{- range $protoName, $proto := .Values.protocols }}
{{-   if $proto}}
---
kind: ServiceAccount
apiVersion: v1
metadata:
  name: load-{{ $protoName }}
  namespace: {{ $ns }}
  labels:
    app: ort
    ort.olix0r.net/role: load
    ort.olix0r.net/protocol: {{ $protoName }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: ort
    ort.olix0r.net/role: load
    ort.olix0r.net/protocol: {{ $protoName }}
  name: load-{{ $protoName }}
  namespace: {{ $ns }}
spec:
  replicas: {{ int $load.replicas }}
  selector:
    matchLabels:
      app: ort
      ort.olix0r.net/role: load
      ort.olix0r.net/protocol: {{ $protoName }}
  template:
    metadata:
      labels:
        app: ort
        ort.olix0r.net/role: load
        ort.olix0r.net/protocol: {{ $protoName }}
      annotations:
{{ $linkerd | include "ort.linkerd" | indent 8 }}
    spec:
      serviceAccount: load-{{ $protoName }}
      containers:
        - name: main
          image: {{ $img }}
          env:
            - name: RUST_LOG
              value: {{ $load.log | default "info" | quote }}
          {{- if eq $linkerd.inject "disabled" }}
            - name: LINKERD_DISABLED
              value: "true"
          {{- end }}
          args:
          {{- if $load.threads }}
            - --threads={{ $load.threads }}
          {{- end }}
            - load
          {{- $flags := deepCopy $proto.loadFlags | merge $load.flags }}
          {{- range $f, $v := $flags }}
            - --{{ kebabcase $f }}={{ $v }}
          {{- end }}
          {{- range $i, $e := until $services }}
            - {{ printf "%s://server-%03d:%d" $protoName $i (int $proto.port) }}
          {{- end }}
{{-   end }}
{{- end }}
